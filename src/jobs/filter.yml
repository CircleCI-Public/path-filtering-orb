description: >
  Continues a pipeline in the `setup` state based with static config
  and a set of pipeline parameters based on the changes in this push.

orbs: 
  git: guitarrapc/git-shallow-clone@2.4.0

executor:
  name: default
  tag: << parameters.tag >>

resource_class: << parameters.resource_class >>

parameters:
  base-revision:
    type: string
    default: "main"
    description: >
      The revision to compare the current one against for the purpose
      of determining changed files.
  mapping:
    type: string
    default: ""
    description: >
      Mapping of path regular expressions to pipeline parameters and
      values. One mapping per line, whitespace-delimited.
  config-path:
    type: string
    default: ".circleci/continue_config.yml"
    description: >
      The location of the config to continue the pipeline with.
  circleci_domain:
    type: string
    description: "The domain of the CircleCI installation - defaults to circleci.com. (Only necessary for CircleCI Server users)"
    default: "circleci.com"
  workspace_path:
    type: string
    description: "Path to attach the workspace to"
    default: ""
  resource_class:
    type: string
    description: "Resource class to use"
    default: "small"
  tag:
    type: string
    default: "3.8"
    description: >
      Pick a specific circleci/python image variant:
      https://hub.docker.com/r/cimg/python/tags
  enable_shallow_checkout:
    type: boolean
    description: "Flag value for whether shallow checkout is used or not"
    default: false
  checkout_shallow_depth:
    type: string
    description: "shallow checkout depth"
    default: "100"
  checkout_shallow_fetch_depth:
    type: string
    description: "shallow checkout fetch depth"
    default: "100"

steps:
  - when:
      condition:
        not:
          equal: [ "", << parameters.enable_shallow_checkout >> ]
      steps:
        - checkout
  - when:
      condition:
          equal: [ "", << parameters.enable_shallow_checkout >> ]
      steps:
        - git/checkout_shallow:
            depth: [ "1", << parameters.checkout_shallow_depth >> ]
            fetch_depth: [ "1", << parameters.checkout_shallow_fetch_depth >> ]
  - when:
      condition:
        not:
          equal: ["", << parameters.workspace_path >>]
      steps:
        - attach_workspace:
            at: << parameters.workspace_path >>
  - set-parameters:
      base-revision: << parameters.base-revision >>
      mapping: << parameters.mapping >>
  - continuation/continue:
      configuration_path: << parameters.config-path >>
      parameters: "/tmp/pipeline-parameters.json"
      circleci_domain: << parameters.circleci_domain >>
